@model List<QuanLyThongTinDaoTao.Models.BuoiHoc>

@{
    ViewBag.Title = "Lịch Học";
    Layout = "~/Views/Shared/_MainLayout.cshtml";

    // Lấy danh sách các ngày học trong tuần (Thứ 2 -> Chủ Nhật)
    var ngayHocTuan = Enumerable.Range(0, 7)
        .Select(i => DateTime.Today.AddDays(i - (int)DateTime.Today.DayOfWeek + 1)) // Lấy ngày đầu tuần
        .ToList();
    // Ngày mặc định (hôm nay)
    DateTime ngayHienTai = DateTime.Today;

    // Hàm lấy buổi học theo ca (Sáng, Chiều)
    Func<DateTime, string, List<QuanLyThongTinDaoTao.Models.BuoiHoc>> getBuoiHoc = (ngay, ca) =>
    {
        return Model.Where(bh =>
            bh.NgayHoc.Date == ngay &&
            ((ca == "Sáng" && bh.GioBatDau.Hours < 12) ||
             (ca == "Chiều" && bh.GioBatDau.Hours >= 12 && bh.GioBatDau.Hours < 18))
        ).ToList();
    };
}

<div class="container my-4" id="lichHocContainer">
    <!-- Thanh công cụ -->
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
        <div class="d-flex flex-wrap align-items-center gap-2">
            <input type="date" id="selectedDate" class="form-control" style="min-width: 200px;">
            <button id="goToToday" class="btn btn-success">
                <i class="fa-solid fa-calendar-day"></i> Hôm nay
            </button>
            <button id="prevWeek" class="btn btn-primary">
                <i class="fa-solid fa-chevron-left"></i> Trở về
            </button>
            <button id="nextWeek" class="btn btn-primary">
                Tiếp <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-warning" onclick="printSchedule()">
                <i class="fa-solid fa-print"></i> In lịch
            </button>
            <button class="btn btn-info" onclick="toggleFullscreen()">
                <i class="fa-solid fa-expand"></i>
            </button>
        </div>
    </div>

    <!-- Bảng thời khóa biểu -->
    <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
            <thead class="table-success">
                <tr>
                    <th style="min-width: 120px;">Ca học</th>
                    @foreach (var ngay in ngayHocTuan)
                    {
                        <th>
                            @ngay.ToString("dddd") <br />
                            @ngay.ToString("dd/MM/yyyy")
                        </th>

                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var ca in new[] { "Sáng", "Chiều" })
                {
                    <tr>
                        <td class="fw-bold">@ca</td>
                        @foreach (var ngay in ngayHocTuan)
                        {
                            var buoiHocList = getBuoiHoc(ngay, ca);
                            <td>
                                @if (buoiHocList.Any())
                                {
                                    foreach (var buoiHoc in buoiHocList)
                                    {
                                        <div class="class-info mb-2 p-2 text-start bg-light border rounded">
                                            <div class="fw-bold">@buoiHoc.LopHoc.TenLopHoc</div>
                                            <div>Tiết: @buoiHoc.GioBatDau.Hours - @buoiHoc.GioKetThuc.Hours</div>
                                            <div>Phòng: Zoom</div>
                                            <div>Trạng Thái: @buoiHoc.TrangThai</div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">--</span>
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- JavaScript -->
<script>
    $(document).ready(function () {
    var today = new Date();
    var currentWeekStart = new Date(today);
    currentWeekStart.setDate(today.getDate() - today.getDay() + 1); // Đặt về Thứ 2

    function loadSchedule(startDate) {
        var formattedDate = startDate.toISOString().split("T")[0]; // yyyy-MM-dd
        $("#selectedDate").val(formattedDate);

        $.ajax({
            url: '@Url.Action("LichHoc", "QuanLyHocTap")',
            type: 'GET',
            data: { startDate: formattedDate },
            success: function (response) {
                $("#lichHocContainer").html(response);
            },
            error: function () {
                alert("Không thể tải lịch học.");
            }
        });
    }

    // Cập nhật lịch khi chọn ngày
    $("#selectedDate").change(function () {
        var selectedDate = new Date($(this).val());
        currentWeekStart = new Date(selectedDate);
        currentWeekStart.setDate(selectedDate.getDate() - selectedDate.getDay() + 1); // Cập nhật đầu tuần
        loadSchedule(currentWeekStart);
    });

    // Chuyển sang tuần trước
    $("#prevWeek").click(function () {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7); // Lùi 7 ngày
        loadSchedule(currentWeekStart);
    });

    // Chuyển sang tuần sau
    $("#nextWeek").click(function () {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7); // Tiến 7 ngày
        loadSchedule(currentWeekStart);
    });

    // Trở về hôm nay
    $("#goToToday").click(function () {
        currentWeekStart = new Date();
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay() + 1);
        loadSchedule(currentWeekStart);
    });

    // Tải lịch học lần đầu
    loadSchedule(currentWeekStart);
});

</script>